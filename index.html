<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Roadmap des projets</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --nord0: #2e3440;
            --nord4: #d8dee9;
            --nord6: #eceff4;
            --nord7: #8fbcbb;
            --nord8: #88c0d0;
            --nord9: #81a1c1;
            --nord10: #5e81ac;
            --nord11: #bf616a;
            --nord12: #d08770;
            --nord13: #ebcb8b;
            --nord14: #a3be8c;
            --nord15: #b48ead;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; background-color: #f8f9fa; color: #3b4252; margin: 0; padding: 20px; }
        .main-header { display: flex; align-items: center; gap: 25px; max-width: 1800px; margin: 0 auto 20px auto; }
        .logo { height: 50px; object-fit: contain; }
        h1 { text-align: left; color: var(--nord12); font-weight: 600; margin: 0; flex-grow: 1; }
        h1 span.version-tag { font-size: 0.5em; color: #4c566a; font-weight: normal; vertical-align: middle; }
        .logo-group-right { display: flex; align-items: center; gap: 20px; }
        .page-container { display: flex; flex-direction: column; gap: 30px; max-width: 1800px; margin: 0 auto; }
        .controls-container, .gantt-container, .versions-manager, .workload-container, .dashboard-container, .docs-container, .accueil-container { background-color: #ffffff; padding: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border-radius: 12px; border: 1px solid var(--nord4); }
        .versions-manager { max-width: 1800px; margin: 0 auto 30px auto; padding: 25px 30px; }
        .controls-container h2, .versions-manager h3, .dashboard-container h2 { margin-top: 0; font-size: 1.4em; color: var(--nord0); }
        .versions-manager h3 { font-size: 1.1em; color: #434c5e;}

        .tabs-nav { display: flex; border-bottom: 2px solid var(--nord4); margin-bottom: 30px; flex-wrap: wrap; }
        .tab-link { padding: 12px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1em; color: #4c566a; border-bottom: 3px solid transparent; margin-bottom: -2px; display: flex; align-items: center; gap: 8px; }
        .tab-link.active { color: var(--nord10); border-bottom-color: var(--nord10); font-weight: 600; }
        .tab-link:hover { background-color: var(--nord6); }
        
        .chart-comment { color: #4c566a; text-align: center; margin-top: 20px; font-style: italic; max-width: 800px; margin-left: auto; margin-right: auto; }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-filter-container { max-width: 250px; }
        .chart-filter-container label { display: block; font-weight: 500; color: #4c566a; margin-bottom: 5px; font-size: 0.9em; }

        .chart-counter { font-size: 1.1em; color: var(--nord12); font-weight: 500; white-space: nowrap; }

        #tasks-table { width: 100%; border-collapse: collapse; }
        #tasks-table th, #tasks-table td { padding: 8px; text-align: left; vertical-align: top; }
        #tasks-table tbody tr { border-bottom: 1px solid var(--nord6); }
        #tasks-table th { font-size: 0.9em; text-transform: uppercase; color: #4c566a; padding-bottom: 12px; font-weight: 600; }
        #tasks-table th.center-header { text-align: center; }
        #tasks-table td.delete-cell { vertical-align: middle; text-align: center; }
        .delete-row-btn { background: none; border: none; color: var(--nord11); font-size: 1.6em; cursor: pointer; padding: 4px 8px; opacity: 0.7; transition: opacity 0.2s, color 0.2s; line-height: 1; border-radius: 4px; }
        .delete-row-btn:hover { opacity: 1; color: var(--nord12); background-color: var(--nord6); }

        #tasks-table td.task-name-cell { vertical-align: middle; }
        #tasks-table td.task-name-cell input { text-align: left; flex-grow: 1; border-color: transparent; background-color: transparent; }
        #tasks-table td.task-name-cell input:hover { border-color: var(--nord4); }
        #tasks-table td.task-name-cell input:focus { border-color: var(--nord10); outline: none; }
        #tasks-table td.task-duration { text-align: center; font-weight: 500; color: #4c566a; white-space: nowrap; vertical-align: middle; }
        #tasks-table input, #tasks-table select { width: 100%; padding: 8px; border: 1px solid var(--nord4); border-radius: 6px; font-family: inherit; font-size: 14px; box-sizing: border-box; }
        #tasks-table input[type="date"], #tasks-table select { text-align: center; }
        
        #tasks-table .filter-row th { padding-bottom: 15px; padding-top: 5px; }
        .header-filter { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--nord4); background-color: #f8f9fa; }
        .header-filter:focus { background-color: #fff; border-color: var(--nord10); outline: none; }
        
        #tasks-table .project-counter-sync { text-align: right; vertical-align: middle; font-size: 1.1em; color: var(--nord12); font-weight: 500; padding-right: 10px; white-space: nowrap; text-transform: none; }

        .edit-desc-btn { background-color: var(--nord6); border: none; color: #4c566a; padding: 8px 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 13px; font-weight: 500; }
        .edit-desc-btn:hover { background-color: var(--nord4); }

        #versions-select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--nord4); background-color: #fff; font-size: 15px; }
        .button { display: block; flex: 1; width: 100%; padding: 12px; margin-top: 10px; color: #ffffff; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; text-align: center; }
        .save-button { background-color: var(--nord14); } .save-button:hover { background-color: #b5d5a2; }
        .delete-button { background-color: var(--nord12); } .delete-button:hover { background-color: #e59a85; }
        .cancel-button { background-color: var(--nord11); } .cancel-button:hover { background-color: #d08770; }
        .add-button { background-color: var(--nord10); } .add-button:hover { background-color: var(--nord9); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; }
        .modal-content label { display: block; margin-top: 15px; font-weight: 500; color: #4c566a; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; font-size: 1em; margin-top: 5px; border: 1px solid var(--nord4); border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions .button { margin-top: 0; }
        #desc-modal-textarea { width: 100%; font-size: 1em; margin-top: 5px; border: 1px solid var(--nord4); border-radius: 6px; box-sizing: border-box; resize: vertical; padding: 10px; }
        #desc-modal-project-name { font-weight: bold; color: var(--nord0); }
        .hidden { display: none; }
        .default-version-wrapper { display: flex; align-items: center; margin-top: 15px; }
        .default-version-wrapper input { width: auto; margin-right: 10px; }
        .default-version-wrapper label { margin: 0; }
        
        .accueil-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 20px; }
        .accueil-card { background-color: var(--nord6); padding: 25px; border-radius: 10px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--nord4); position: relative; }
        .accueil-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .accueil-card-icon { font-size: 3em; margin-bottom: 15px; }
        .accueil-card h3 { margin: 0; font-size: 1.3em; color: var(--nord0); }

        .docs-container h3 { color: var(--nord10); border-bottom: 2px solid var(--nord6); padding-bottom: 10px; margin-top: 30px; }
        .docs-container p, .docs-container li { line-height: 1.6; color: #4c566a; }
        .docs-container ul { padding-left: 20px; }
        
        .dashboard-container .chart-comment { text-align: left; margin-left: 0; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--nord6); padding: 20px; border-radius: 10px; border: 1px solid var(--nord4); position: relative; }
        .kpi-card.clickable { cursor: pointer; transition: background-color 0.2s; }
        .kpi-card.clickable:hover { background-color: var(--nord4); }
        .kpi-card.tooltip-enabled { cursor: help; }
        .kpi-card h3 { font-size: 1.1em; color: #4c566a; margin: 0 0 10px 0; font-weight: 500; }
        .kpi-value { font-size: 2.5em; font-weight: 600; color: var(--nord0); margin: 0; }
        .kpi-card.late { background-color: #ffefef; border-color: var(--nord11); }
        .kpi-card.late .kpi-value { color: var(--nord11); }
        .mini-chart-container { grid-column: 1 / -1; min-height: 350px; cursor: default; }

        .tooltip-text-accueil, .kpi-card .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--nord0);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
            font-weight: 400;
            pointer-events: none;
        }

        .tooltip-text-accueil::after, .kpi-card .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--nord0) transparent transparent transparent;
        }

        .accueil-card:hover .tooltip-text-accueil, .kpi-card:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        #kpi-modal-body ul {
            list-style-type: none;
            padding: 0;
            margin: 20px 0 0 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        #kpi-modal-body li {
            padding: 10px;
            border-bottom: 1px solid var(--nord6);
            font-size: 0.95em;
        }
        #kpi-modal-body li:last-child {
            border-bottom: none;
        }
        #kpi-modal-body li i {
            color: #4c566a;
            font-size: 0.9em;
        }

        @media print { @page { size: A4 landscape; margin: 1cm; } .controls-container, .versions-manager, .main-header, .tabs-nav, .workload-container, .chart-header { display: none; } .page-container { flex-direction: column; align-items: flex-start; max-width: 100%; gap: 0; } .gantt-container { width: 100%; max-width: 100%; flex: auto; box-shadow: none; border: none; } .gantt-container.hidden { display: block !important; } }
    </style>
</head>
<body>
    <div class="main-header">
        <img src="SGS_Logo.svg.png" alt="Logo SGS" class="logo">
        <h1>Roadmap des projets <span class="version-tag">v1.5.0</span></h1>
        <div class="logo-group-right">
            <img src="securitest.png" alt="Logo Securitest" class="logo">
            <img src="auto-securite.png" alt="Logo Auto Sécurité" class="logo">
            <img src="verifautos.jpg" alt="Logo Verif'autos" class="logo">
        </div>
    </div>
    <div class="versions-manager">
        <h3>Charger une version</h3>
        <select id="versions-select">
            <option value="">-- Chargement des versions... --</option>
        </select>
    </div>
    <div class="page-container">
        <div class="tabs-nav">
            <button class="tab-link active" data-tab="accueil-container">🏠 Accueil</button>
            <button class="tab-link" data-tab="dashboard-container">📊 Tableau de Bord</button>
            <button class="tab-link" data-tab="controls-container">📝 Planning & Saisie</button>
            <button class="tab-link" data-tab="gantt-container">📊 Vue Gantt</button>
            <button class="tab-link" data-tab="workload-container">📈 Analyse de charge</button>
            <button class="tab-link" data-tab="status-split-container">🚦 Répartition par statut</button>
            <button class="tab-link" data-tab="sponsor-split-container">👥 Projets par sponsor</button>
            <button class="tab-link" data-tab="sponsor-status-container">🚀 Avancement par sponsor</button>
            <button class="tab-link" data-tab="docs-container">📖 Documentation</button>
        </div>

        <div id="accueil-container" class="accueil-container content-tab">
             <div class="accueil-grid">
                <div class="accueil-card" data-tab="dashboard-container">
                    <div class="accueil-card-icon">📊</div>
                    <h3>Tableau de Bord</h3>
                    <span class="tooltip-text-accueil">Vue synthétique des indicateurs clés (KPIs) du portefeuille de projets.</span>
                </div>
                <div class="accueil-card" data-tab="controls-container">
                    <div class="accueil-card-icon">📝</div>
                    <h3>Planning & Saisie</h3>
                    <span class="tooltip-text-accueil">Interface pour ajouter, modifier et supprimer les projets de la roadmap.</span>
                </div>
                <div class="accueil-card" data-tab="gantt-container">
                    <div class="accueil-card-icon">📊</div>
                    <h3>Vue Gantt</h3>
                    <span class="tooltip-text-accueil">Diagramme chronologique pour visualiser la durée et le chevauchement des projets.</span>
                </div>
                <div class="accueil-card" data-tab="workload-container">
                    <div class="accueil-card-icon">📈</div>
                    <h3>Analyse de charge</h3>
                    <span class="tooltip-text-accueil">Graphique montrant le nombre de projets actifs simultanément dans le temps.</span>
                </div>
                <div class="accueil-card" data-tab="status-split-container">
                    <div class="accueil-card-icon">🚦</div>
                    <h3>Répartition par statut</h3>
                    <span class="tooltip-text-accueil">Vue d'ensemble de la proportion des projets 'À faire', 'En cours' et 'Terminés'.</span>
                </div>
                <div class="accueil-card" data-tab="sponsor-split-container">
                    <div class="accueil-card-icon">👥</div>
                    <h3>Projets par sponsor</h3>
                    <span class="tooltip-text-accueil">Classement des sponsors selon le nombre de projets qu'ils portent.</span>
                </div>
                <div class="accueil-card" data-tab="sponsor-status-container">
                    <div class="accueil-card-icon">🚀</div>
                    <h3>Avancement par sponsor</h3>
                    <span class="tooltip-text-accueil">Analyse détaillée de l'avancement des projets pour chaque sponsor.</span>
                </div>
                <div class="accueil-card" data-tab="docs-container">
                    <div class="accueil-card-icon">📖</div>
                    <h3>Documentation</h3>
                    <span class="tooltip-text-accueil">Guide d'utilisation et explication des fonctionnalités de l'application.</span>
                </div>
            </div>
        </div>
        
        <div id="dashboard-container" class="dashboard-container content-tab hidden">
            <h2>Tableau de Bord Synthétique</h2>
            <div class="kpi-grid">
                <div class="kpi-card clickable" id="kpi-card-total">
                    <h3>Total Projets</h3>
                    <p class="kpi-value" id="kpi-total-projects">0</p>
                    <span class="tooltip-text">Nombre total de projets chargés dans la version actuelle de la roadmap.</span>
                </div>
                <div class="kpi-card late clickable" id="kpi-card-late">
                    <h3>Projets en Retard</h3>
                    <p class="kpi-value" id="kpi-late-projects">0</p>
                    <span class="tooltip-text">Nombre de projets dont la date de fin est dépassée et dont le statut n'est pas 'Terminé'.</span>
                </div>
                <div class="kpi-card clickable" id="kpi-card-in-progress">
                    <h3>En Cours</h3>
                    <p class="kpi-value" id="kpi-in-progress">0</p>
                    <span class="tooltip-text">Nombre de projets ayant actuellement le statut 'En cours'.</span>
                </div>
                <div class="kpi-card tooltip-enabled">
                    <h3>Sponsor le plus actif</h3>
                    <p class="kpi-value" id="kpi-top-sponsor">N/A</p>
                    <span class="tooltip-text">Le sponsor ayant le plus grand nombre de projets, tous statuts confondus.</span>
                </div>
                <div class="kpi-card mini-chart-container">
                     <h3>Répartition par Statut</h3>
                     <div id="mini-status-chart"></div>
                </div>
            </div>
        </div>

        <div id="docs-container" class="docs-container content-tab hidden">
            <h2>Documentation de l'application Roadmap Projets (v1.5.0)</h2>
            <h3>1. Objectif de l'application</h3>
            <p>Cette application a été conçue pour offrir une vue claire et dynamique de l'ensemble des projets gérés par la direction digitale pour ses différents sponsors. Elle sert d'outil central pour la planification, le suivi et l'analyse de la charge de travail.</p>
            
            <h3>2. Fonctionnalités générales</h3>
            <ul>
                <li><strong>Gestion des versions :</strong> Vous pouvez sauvegarder différentes versions de la roadmap (par exemple, une par trimestre). Le menu déroulant en haut de page permet de charger une version existante.</li>
                <li><strong>Filtres dynamiques :</strong> La plupart des vues peuvent être filtrées par "Sponsor" pour affiner l'analyse. Les filtres sont synchronisés entre les onglets.</li>
                <li><strong>Sauvegarde en temps réel :</strong> Toutes les modifications (changement de date, de nom, etc.) sont prises en compte instantanément. Pour les sauvegarder sur le long terme, il faut créer ou mettre à jour une version via le bouton "Gérer les versions".</li>
            </ul>

            <h3>3. Détail des vues (onglets)</h3>
            
            <h3>🏠 Accueil</h3>
            <p>C'est la porte d'entrée de l'application. Chaque carte est un raccourci cliquable qui vous amène directement à l'onglet correspondant pour une navigation intuitive.</p>

            <h3>📊 Tableau de Bord</h3>
            <p>Cet écran offre une vue d'ensemble managériale avec des indicateurs de performance clés (KPIs). Il permet de prendre le pouls du portefeuille de projets en un coup d'œil.</p>
            <ul>
                <li><strong>Cartes d'indicateurs :</strong> Affichent le nombre total de projets, les projets en retard, ceux en cours, et le sponsor le plus actif.</li>
                <li><strong>Interactivité :</strong> Les cartes "Total Projets", "Projets en Retard" et "En Cours" sont cliquables. Un clic ouvre une fenêtre affichant la liste détaillée des projets concernés.</li>
                <li><strong>Info-bulles :</strong> Survolez une carte pour obtenir une explication claire sur ce que l'indicateur représente.</li>
            </ul>

            <h3>📝 Planning & Saisie</h3>
            <p>C'est l'écran principal pour la gestion des données. Vous pouvez y :</p>
            <ul>
                <li><strong>Ajouter un projet :</strong> Via le bouton "Ajouter un projet".</li>
                <li><strong>Modifier un projet :</strong> En cliquant directement dans les champs (Sponsor, Projet, Début, Fin, Statut).</li>
                <li><strong>Supprimer un projet :</strong> En cliquant sur l'icône "×" au début de chaque ligne.</li>
                <li><strong>Ajouter une description :</strong> Le bouton "Détails" ouvre une fenêtre pour ajouter une description plus complète du projet, qui sera visible dans la vue Gantt.</li>
            </ul>

            <h3>📊 Vue Gantt</h3>
            <p>Cette vue offre une représentation chronologique des projets sous forme de diagramme de Gantt. Chaque barre représente la durée d'un projet. La ligne rouge verticale indique la date du jour, permettant de voir immédiatement les projets en retard.</p>
            
            <h3>📈 Analyse de charge</h3>
            <p>Ce graphique montre le nombre de projets actifs simultanément pour chaque jour. C'est un excellent indicateur pour visualiser les périodes de forte charge et anticiper les éventuels goulets d'étranglement.</p>
            
            <h3>🚦 Répartition par statut</h3>
            <p>Ce graphique en Donut montre la proportion de projets "À faire", "En cours" et "Terminés". Il offre une vue synthétique de l'avancement global du portefeuille de projets.</p>

            <h3>👥 Projets par sponsor</h3>
            <p>Ce diagramme à barres classe les sponsors en fonction du nombre de projets qu'ils ont soumis. Ce graphique mesure la demande de chaque sponsor auprès de l'équipe digitale.</p>

            <h3>🚀 Avancement par sponsor</h3>
            <p>C'est la vue la plus riche en informations. Elle combine les deux précédentes en montrant pour chaque sponsor la répartition de ses projets par statut. On peut ainsi voir non seulement qui a le plus de projets, mais aussi la dynamique d'avancement de chaque sponsor.</p>
        </div>

        <div id="status-split-container" class="content-tab hidden">
            <div id="status-split-chart"></div>
            <p class="chart-comment">Ce graphique montre la proportion de projets "À faire", "En cours" et "Terminés" sur l'ensemble du portefeuille. </p>
        </div>
        
        <div id="sponsor-split-container" class="content-tab hidden">
             <div id="sponsor-split-chart"></div>
             <p class="chart-comment">Ce diagramme à barres mesure la demande de chaque sponsor auprès de l'équipe digitale.</p>
        </div>

        <div id="sponsor-status-container" class="content-tab hidden">
             <div id="sponsor-status-chart"></div>
             <p class="chart-comment">Ce graphique combine le nombre de projets par sponsor avec leur statut d'avancement. Il permet d'évaluer à la fois la charge de travail et la dynamique de chaque sponsor.</p>
        </div>

        <div id="gantt-container" class="gantt-container content-tab hidden">
            <div class="chart-header">
                <div class="chart-filter-container">
                    <label for="sponsor-filter-gantt">Filtre Sponsor Actif</label>
                    <select id="sponsor-filter-gantt" class="header-filter sponsor-filter-sync"></select>
                </div>
                <p id="gantt-counter" class="project-counter-sync chart-counter" style="text-align: right; width: 100%;"></p>
            </div>
            <div id="gantt-chart"></div>
            <p class="chart-comment">Ce diagramme de Gantt illustre la chronologie des projets. Chaque barre représente la durée d'un projet, de sa date de début à sa date de fin.</p>
        </div>
        <div id="workload-container" class="workload-container content-tab hidden">
            <div class="chart-header">
                <div class="chart-filter-container">
                    <label for="sponsor-filter-workload">Filtre Sponsor Actif</label>
                    <select id="sponsor-filter-workload" class="header-filter sponsor-filter-sync"></select>
                </div>
                <p id="workload-counter" class="project-counter-sync chart-counter" style="text-align: right; width: 100%;"></p>
            </div>
            <div id="workload-chart"></div>
            <p class="chart-comment">Ce graphique représente le nombre de projets actifs simultanément pour chaque jour de la période couverte par la roadmap.</p>
        </div>
        <div id="controls-container" class="controls-container content-tab hidden">
            <h2>Planning</h2>
            <div id="table-wrapper"></div>
            <button class="button add-button" id="add-task-btn">Ajouter un projet</button>
            <button class="button save-button" id="manage-versions-btn">Gérer les versions...</button>
        </div>
    </div>

    <div id="save-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Gérer les versions</h3>
            <label for="modal-versions-select">Action</label>
            <select id="modal-versions-select"><option value="new">Créer une nouvelle version</option></select>
            <label for="version-name-input">Nom de la version</label>
            <input type="text" id="version-name-input" placeholder="Nom de la nouvelle version...">
            <div id="default-version-wrapper" class="default-version-wrapper hidden">
                <input type="checkbox" id="set-as-default-checkbox">
                <label for="set-as-default-checkbox">Définir comme version par défaut</label>
            </div>
            <div class="modal-actions">
                <button id="confirm-save-btn" class="button save-button">Mettre à jour</button>
                <button id="confirm-delete-btn" class="button delete-button hidden">Supprimer</button>
                <button id="cancel-save-btn" class="button cancel-button">Annuler</button>
            </div>
        </div>
    </div>

    <div id="description-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Description du projet</h3>
            <p><strong>Projet :</strong> <span id="desc-modal-project-name"></span></p>
            <label for="desc-modal-textarea">Description</label>
            <textarea id="desc-modal-textarea" rows="10"></textarea>
            <div class="modal-actions">
                <button id="confirm-desc-btn" class="button save-button">Valider</button>
                <button id="cancel-desc-btn" class="button cancel-button">Annuler</button>
            </div>
        </div>
    </div>

    <div id="kpi-details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="kpi-modal-title">Détails</h3>
            <div id="kpi-modal-body"></div>
            <div class="modal-actions">
                <button id="close-kpi-modal-btn" class="button cancel-button">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB8OWLAAZr9kVdZKZgYTndAd8fPUCzLxMc",
            authDomain: "gantt-agenda-sgs.firebaseapp.com",
            projectId: "gantt-agenda-sgs",
            storageBucket: "gantt-agenda-sgs.appspot.com",
            messagingSenderId: "993389286221",
            appId: "1:993389286221:web:1f2adf3435c014b4851d04",
            measurementId: "G-QVK435BBE5"
        };
        const initialTasks = []; 
        const sponsors = ['AGREMENT', 'COMMERCE', 'COMPTABILITE', 'DIGITAL', 'FORMATION', 'L', 'MARKETING', 'NEOBIZ', 'NR', 'QUALITE', 'REGLEMENTAIRE', 'TECHNIQUE'];
        
        let currentTasks = [];
        let displayedTasks = [];
        let sponsorFilter = 'all';
        let projectFilter = '';
        let allVersions = [];
        let filterDebounceTimer;
        let chart;
        let workloadChart;
        let statusSplitChart, sponsorSplitChart, sponsorStatusChart, miniStatusChart;
        let db;

        const calculateDuration = (start, end) => {
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (isNaN(startDate) || isNaN(endDate) || endDate < startDate) return 0;
            return Math.round((endDate - startDate) / (1000 * 3600 * 24)) + 1;
        };

        const formatDataForChart = (tasks) => [{
             name: 'Planning', 
             data: tasks.map(t => ({ 
                 x: `[${t.sponsor}] ${t.name}`, 
                 y: [new Date(t.start).getTime(), new Date(t.end).getTime()] 
            })) 
        }];
        
        const calculateWorkloadData = (tasks) => {
            if (tasks.length === 0) {
                return [{ name: "Projets actifs", data: [] }];
            }
            
            const workload = new Map();
            let minDate = new Date(tasks[0].start);
            let maxDate = new Date(tasks[0].end);

            tasks.forEach(task => {
                const start = new Date(task.start);
                const end = new Date(task.end);
                if (start < minDate) minDate = start;
                if (end > maxDate) maxDate = end;
            });

            for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
                workload.set(d.toISOString().split('T')[0], 0);
            }

            tasks.forEach(task => {
                const start = new Date(task.start);
                const end = new Date(task.end);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().split('T')[0];
                    if (workload.has(dateString)) {
                        workload.set(dateString, workload.get(dateString) + 1);
                    }
                }
            });
            
            const data = Array.from(workload.entries()).map(([date, count]) => {
                return { x: new Date(date).getTime(), y: count };
            });

            data.sort((a,b) => a.x - b.x);
            return [{ name: "Projets actifs", data: data }];
        };

        const populateSponsorFilters = () => {
            const sponsorOptions = sponsors.map(s => `<option value="${s}">${s}</option>`).join('');
            document.querySelectorAll('.sponsor-filter-sync').forEach(filter => {
                filter.innerHTML = `<option value="all">Tous sponsors</option>${sponsorOptions}`;
                filter.value = sponsorFilter;
            });
        };

        const syncSponsorFilters = () => {
            document.querySelectorAll('.sponsor-filter-sync').forEach(filter => {
                filter.value = sponsorFilter;
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } 
            catch (e) { console.error("Erreur d'initialisation de Firebase", e); }

            populateSponsorFilters();

            const handleSponsorFilterChange = (e) => {
                sponsorFilter = e.target.value;
                refreshUI();
            };

            const elements = {
                saveModal: document.getElementById('save-modal'), versionNameInput: document.getElementById('version-name-input'),
                versionsSelect: document.getElementById('versions-select'), modalVersionsSelect: document.getElementById('modal-versions-select'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'), defaultVersionWrapper: document.getElementById('default-version-wrapper'),
                setAsDefaultCheckbox: document.getElementById('set-as-default-checkbox'),
                descModal: document.getElementById('description-modal'), descModalProjectName: document.getElementById('desc-modal-project-name'),
                descModalTextarea: document.getElementById('desc-modal-textarea'),
                tableWrapper: document.getElementById('table-wrapper'),
                ganttChart: document.querySelector("#gantt-chart"),
                workloadChart: document.querySelector("#workload-chart"),
                statusSplitChart: document.querySelector("#status-split-chart"),
                sponsorSplitChart: document.querySelector("#sponsor-split-chart"),
                sponsorStatusChart: document.querySelector("#sponsor-status-chart"),
                miniStatusChart: document.querySelector("#mini-status-chart"),
                kpiDetailsModal: document.getElementById('kpi-details-modal'),
                kpiModalTitle: document.getElementById('kpi-modal-title'),
                kpiModalBody: document.getElementById('kpi-modal-body')
            };
            
            const chartOptions = {
                series: [], chart: { height: 800, type: 'rangeBar', zoom: { enabled: false } },
                plotOptions: { bar: { horizontal: true, borderRadius: 5, barHeight: '70%' } },
                fill: { type: 'solid' },
                colors: [({ dataPointIndex }) => {
                    const task = displayedTasks[dataPointIndex];
                    if (!task) return '#d08770';
                    if (new Date(task.end) < new Date() && task.status !== 'Terminé') return '#bf616a';
                    if (task.status === 'Terminé') return '#a3be8c';
                    return '#d08770';
                }],
                xaxis: { type: 'datetime', labels: { datetimeUTC: false, style: { colors: '#888' } } },
                yaxis: { labels: { style: { fontSize: '14px', colors: '#3b4252' }, trim: false, maxWidth: 400 } },
                grid: { borderColor: '#e5e9f0', row: { colors: ['#f9fafb', '#ffffff'], opacity: 1 } },
                tooltip: { 
                    theme: 'dark', 
                    custom: ({ seriesIndex, dataPointIndex }) => { 
                        const task = displayedTasks[dataPointIndex]; 
                        if (!task) return ''; 
                        const options = { year: 'numeric', month: 'long', day: 'numeric' }; 
                        const startDate = new Date(task.start).toLocaleDateString('fr-FR', options); 
                        const endDate = new Date(task.end).toLocaleDateString('fr-FR', options);
                        const taskDisplayName = `[${task.sponsor}] ${task.name}`;
                        const descriptionHtml = task.description ? task.description.replace(/\n/g, '<br>') : '<i>Aucune description</i>';
                        const descriptionStyle = "font-style: italic; opacity: 0.9; margin-top: 10px; padding-top: 10px; border-top: 1px solid #4c566a; max-width: 350px; white-space: normal; overflow-wrap: break-word;";
                        return `<div class="apexcharts-tooltip-box"><div class="apexcharts-tooltip-title">${taskDisplayName}</div><div><strong>Du:</strong> ${startDate}</div><div><strong>Au:</strong> ${endDate}</div><div style="${descriptionStyle}">${descriptionHtml}</div></div>`; 
                    } 
                },
                annotations: { xaxis: [{ x: new Date().getTime(), borderColor: '#e44d26', strokeDashArray: 2, label: { text: 'Aujourd\'hui', borderColor: '#e44d26', style: { color: '#fff', background: '#e44d26' } } }] }
            };
            chart = new ApexCharts(elements.ganttChart, chartOptions);
            chart.render();

            const workloadChartOptions = {
                series: [],
                chart: { type: 'area', height: 600, zoom: { enabled: false } },
                colors: ['#d08770'],
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth' },
                xaxis: { 
                    type: 'datetime',
                    labels: { datetimeUTC: false, style: { colors: '#888' } }
                },
                yaxis: {
                    title: { text: 'Nombre de projets actifs' },
                    min: 0,
                    labels: {
                        formatter: function (val) { return val.toFixed(0); }
                    }
                },
                tooltip: { x: { format: 'dd MMMM yyyy' } },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } }
            };
            workloadChart = new ApexCharts(elements.workloadChart, workloadChartOptions);
            workloadChart.render();
            
            const statusSplitOptions = {
                series: [], chart: { type: 'donut', height: 450 },
                labels: ['À faire', 'En cours', 'Terminé'],
                colors: ['#ebcb8b', '#d08770', '#a3be8c'],
                legend: { position: 'bottom' },
                responsive: [{ breakpoint: 480, options: { chart: { width: '100%' }, legend: { position: 'bottom' } } }]
            };
            statusSplitChart = new ApexCharts(elements.statusSplitChart, statusSplitOptions);
            statusSplitChart.render();

            const miniStatusOptions = {
                series: [], chart: { type: 'donut', height: 350 },
                labels: ['À faire', 'En cours', 'Terminé'],
                colors: ['#ebcb8b', '#d08770', '#a3be8c'],
                legend: { position: 'bottom' },
                dataLabels: { enabled: false },
            };
            miniStatusChart = new ApexCharts(elements.miniStatusChart, miniStatusOptions);
            miniStatusChart.render();
            
            const sponsorSplitOptions = {
                series: [{ name: 'Projets', data: [] }], chart: { type: 'bar', height: 450 },
                plotOptions: { bar: { horizontal: true } },
                colors: ['#81a1c1'],
                xaxis: { categories: [] }
            };
            sponsorSplitChart = new ApexCharts(elements.sponsorSplitChart, sponsorSplitOptions);
            sponsorSplitChart.render();
            
            const sponsorStatusOptions = {
                series: [], chart: { type: 'bar', height: 600, stacked: true },
                plotOptions: { bar: { horizontal: true } },
                stroke: { width: 1, colors: ['#fff'] },
                xaxis: { categories: [] },
                yaxis: { title: { text: undefined } },
                colors: ['#ebcb8b', '#d08770', '#a3be8c'],
                fill: { opacity: 1 },
                legend: { position: 'top', horizontalAlign: 'left', offsetX: 40 }
            };
            sponsorStatusChart = new ApexCharts(elements.sponsorStatusChart, sponsorStatusOptions);
            sponsorStatusChart.render();

            const tabs = document.querySelectorAll('.tab-link');
            const contentTabs = document.querySelectorAll('.content-tab');
            const accueilCards = document.querySelectorAll('.accueil-card');

            const switchTab = (targetId) => {
                 tabs.forEach(item => {
                    if(item.dataset.tab === targetId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                contentTabs.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === targetId) {
                        content.classList.remove('hidden');
                    }
                });
                if (targetId === 'gantt-container') {
                    chart.updateOptions({ chart: { height: Math.max(600, displayedTasks.length * 45) } });
                }
                if (targetId === 'workload-container') {
                     workloadChart.updateOptions({});
                }
            };

            const showKpiDetailsModal = (title, projects) => {
                elements.kpiModalTitle.textContent = title;
                if (projects.length === 0) {
                    elements.kpiModalBody.innerHTML = '<p>Aucun projet à afficher dans cette catégorie.</p>';
                } else {
                    let listHTML = '<ul>';
                    projects.sort((a,b) => new Date(a.start) - new Date(b.start)).forEach(p => {
                        const endDate = new Date(p.end).toLocaleDateString('fr-FR');
                        listHTML += `<li><strong>[${p.sponsor}]</strong> ${p.name} <i>(Fin: ${endDate})</i></li>`;
                    });
                    listHTML += '</ul>';
                    elements.kpiModalBody.innerHTML = listHTML;
                }
                elements.kpiDetailsModal.classList.remove('hidden');
            };
            
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            accueilCards.forEach(card => card.addEventListener('click', () => switchTab(card.dataset.tab)));

            document.querySelectorAll('#sponsor-filter-gantt, #sponsor-filter-workload').forEach(filter => {
                filter.addEventListener('change', handleSponsorFilterChange);
            });
            
            const renderTable = (tasks) => {
                const sponsorOptions = sponsors.map(s => `<option value="${s}">${s}</option>`).join('');
                let tableHTML = `<table id="tasks-table">
                    <thead>
                        <tr class="filter-row">
                            <th></th>
                            <th><select id="sponsor-filter-table" class="header-filter sponsor-filter-sync"><option value="all">Tous sponsors</option>${sponsorOptions}</select></th>
                            <th><input type="text" id="project-filter" class="header-filter" placeholder="Filtrer projet (3 car. min)..."></th>
                            <th class="project-counter-sync" colspan="5" style="text-align: right; width: 100%;"></th>
                        </tr>
                        <tr>
                            <th style="width: 5%;"></th>
                            <th class="center-header" style="width: 15%;">Sponsor</th>
                            <th class="center-header">Projet</th>
                            <th class="center-header" style="width: 12%;">Début</th>
                            <th class="center-header" style="width: 12%;">Fin</th>
                            <th class="center-header" style="width: 8%;">Durée (j)</th>
                            <th class="center-header" style="width: 10%;">Description</th>
                            <th class="center-header" style="width: 12%;">Statut</th>
                        </tr>
                    </thead>
                    <tbody>`;

                tasks.forEach((task) => {
                    const duration = calculateDuration(task.start, task.end);
                    tableHTML += `<tr>
                        <td class="delete-cell"><button class="delete-row-btn" data-id="${task.id}" title="Supprimer ce projet">×</button></td>
                        <td><select data-id="${task.id}" data-type="sponsor">${sponsors.map(s => `<option value="${s}" ${task.sponsor === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                        <td class="task-name-cell"><input type="text" value="${task.name}" data-id="${task.id}" data-type="name"></td>
                        <td><input type="date" value="${task.start}" data-id="${task.id}" data-type="start"></td>
                        <td><input type="date" value="${task.end}" data-id="${task.id}" data-type="end"></td>
                        <td class="task-duration">${duration} j</td>
                        <td><button class="edit-desc-btn" data-id="${task.id}">Détails</button></td>
                        <td><select data-id="${task.id}" data-type="status">
                            <option value="À faire" ${task.status === 'À faire' ? 'selected' : ''}>À faire</option>
                            <option value="En cours" ${task.status === 'En cours' ? 'selected' : ''}>En cours</option>
                            <option value="Terminé" ${task.status === 'Terminé' ? 'selected' : ''}>Terminé</option>
                        </select></td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                elements.tableWrapper.innerHTML = tableHTML;

                document.getElementById('sponsor-filter-table').addEventListener('change', handleSponsorFilterChange);

                const projectFilterEl = document.getElementById('project-filter');
                projectFilterEl.value = projectFilter;
                
                projectFilterEl.addEventListener('input', (e) => {
                    clearTimeout(filterDebounceTimer);
                    const inputValue = e.target.value;
                    filterDebounceTimer = setTimeout(() => {
                        projectFilter = inputValue;
                        refreshUI();
                    }, 1000);
                });

                elements.tableWrapper.querySelectorAll('input, select:not(.sponsor-filter-sync)').forEach(input => input.addEventListener('change', handleInputChange));
                elements.tableWrapper.querySelectorAll('.delete-row-btn, .edit-desc-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.id;
                        if (button.classList.contains('delete-row-btn')) {
                            const taskIndex = currentTasks.findIndex(t => t.id === id);
                            if (taskIndex > -1 && confirm(`Supprimer le projet "${currentTasks[taskIndex].name}" ?`)) {
                                currentTasks.splice(taskIndex, 1);
                                refreshUI();
                                localStorage.setItem('ganttCurrentTasks', JSON.stringify(currentTasks));
                            }
                        } else if (button.classList.contains('edit-desc-btn')) {
                            openDescriptionModal(id);
                        }
                    });
                });
            };

            const openDescriptionModal = (taskId) => {
                const task = currentTasks.find(t => t.id === taskId);
                if (!task) return;
                elements.descModal.dataset.editingId = taskId;
                elements.descModalProjectName.textContent = `[${task.sponsor}] ${task.name}`;
                elements.descModalTextarea.value = task.description || '';
                elements.descModal.classList.remove('hidden');
                elements.descModalTextarea.focus();
            };
            
            const updateCounter = () => {
                const allCounters = document.querySelectorAll('.project-counter-sync');
                if (allCounters.length === 0) return;

                const count = displayedTasks.length;
                const plural = count > 1 ? 's' : '';
                let text = `Affiche ${count} projet${plural}`;

                if (sponsorFilter !== 'all') {
                    text += ` pour ${sponsorFilter}`;
                } else {
                    text += `, tous sponsors confondus`;
                }

                allCounters.forEach(counter => {
                    counter.innerHTML = text;
                });
            };

            const applyFilters = () => {
                let filtered = [...currentTasks];
                if (sponsorFilter !== 'all') {
                    filtered = filtered.filter(task => task.sponsor === sponsorFilter);
                }
                const searchTerm = projectFilter.toLowerCase().trim();
                if (searchTerm.length >= 3) {
                    filtered = filtered.filter(task => task.name.toLowerCase().includes(searchTerm));
                }
                return filtered;
            };

            const updateDashboard = () => {
                const totalProjects = currentTasks.length;
                const today = new Date();
                today.setHours(0,0,0,0);
                const lateProjects = currentTasks.filter(t => new Date(t.end) < today && t.status !== 'Terminé').length;
                const inProgressProjects = currentTasks.filter(t => t.status === 'En cours').length;
                
                const sponsorCounts = currentTasks.reduce((acc, task) => {
                    acc[task.sponsor] = (acc[task.sponsor] || 0) + 1;
                    return acc;
                }, {});

                let mostActiveSponsor = 'N/A';
                let maxProjects = 0;
                for (const sponsor in sponsorCounts) {
                    if (sponsorCounts[sponsor] > maxProjects) {
                        maxProjects = sponsorCounts[sponsor];
                        mostActiveSponsor = sponsor;
                    }
                }

                document.getElementById('kpi-total-projects').textContent = totalProjects;
                document.getElementById('kpi-late-projects').textContent = lateProjects;
                document.getElementById('kpi-in-progress').textContent = inProgressProjects;
                document.getElementById('kpi-top-sponsor').textContent = mostActiveSponsor;

                if (lateProjects > 0) {
                    document.getElementById('kpi-card-late').classList.add('late');
                } else {
                    document.getElementById('kpi-card-late').classList.remove('late');
                }
                 const statusCounts = { 'À faire': 0, 'En cours': 0, 'Terminé': 0 };
                currentTasks.forEach(task => { statusCounts[task.status]++; });
                miniStatusChart.updateSeries([statusCounts['À faire'], statusCounts['En cours'], statusCounts['Terminé']]);
            };

            const updateCharts = (tasks) => {
                const chartHeight = Math.max(600, tasks.length * 45);
                if (chart) {
                    chart.updateOptions({
                        chart: { height: chartHeight }, series: formatDataForChart(tasks),
                        annotations: { xaxis: [{ x: new Date().getTime(), borderColor: '#e44d26', strokeDashArray: 2, label: { text: 'Aujourd\'hui', borderColor: '#e44d26', style: { color: '#fff', background: '#e44d26' } } }] }
                    });
                }
                if (workloadChart) {
                    const workloadData = calculateWorkloadData(tasks);
                    const actualMaxY = workloadData[0].data.reduce((max, point) => Math.max(max, point.y), 0);
                    const newYAxisMax = (actualMaxY < 5) ? 5 : Math.ceil(actualMaxY / 5) * 5;
                    workloadChart.updateOptions({
                        series: workloadData,
                        yaxis: { max: newYAxisMax, tickAmount: (newYAxisMax <= 10) ? newYAxisMax : 10 }
                    });
                }
                 const statusCounts = { 'À faire': 0, 'En cours': 0, 'Terminé': 0 };
                tasks.forEach(task => { statusCounts[task.status]++; });
                statusSplitChart.updateSeries([statusCounts['À faire'], statusCounts['En cours'], statusCounts['Terminé']]);

                const sponsorCounts = tasks.reduce((acc, task) => {
                    acc[task.sponsor] = (acc[task.sponsor] || 0) + 1;
                    return acc;
                }, {});
                const sortedSponsors = Object.keys(sponsorCounts).sort((a, b) => sponsorCounts[a] - sponsorCounts[b]);
                sponsorSplitChart.updateOptions({
                    series: [{ data: sortedSponsors.map(s => sponsorCounts[s]) }],
                    xaxis: { categories: sortedSponsors }
                });
                
                const sponsorStatusCounts = {};
                tasks.forEach(task => {
                    if (!sponsorStatusCounts[task.sponsor]) {
                        sponsorStatusCounts[task.sponsor] = { 'À faire': 0, 'En cours': 0, 'Terminé': 0 };
                    }
                    sponsorStatusCounts[task.sponsor][task.status]++;
                });
                const sortedSponsorStatus = Object.keys(sponsorStatusCounts).sort((a, b) => {
                    const totalA = Object.values(sponsorStatusCounts[a]).reduce((sum, val) => sum + val, 0);
                    const totalB = Object.values(sponsorStatusCounts[b]).reduce((sum, val) => sum + val, 0);
                    return totalA - totalB;
                });
                sponsorStatusChart.updateOptions({
                    series: [
                        { name: 'À faire', data: sortedSponsorStatus.map(s => sponsorStatusCounts[s]['À faire']) },
                        { name: 'En cours', data: sortedSponsorStatus.map(s => sponsorStatusCounts[s]['En cours']) },
                        { name: 'Terminé', data: sortedSponsorStatus.map(s => sponsorStatusCounts[s]['Terminé']) }
                    ],
                    xaxis: { categories: sortedSponsorStatus }
                });
            };
            
            const refreshUI = () => {
                currentTasks.sort((a, b) => new Date(a.end) - new Date(b.end));
                displayedTasks = applyFilters();
                renderTable(displayedTasks); 
                updateCharts(displayedTasks);
                updateDashboard();
                updateCounter();
                syncSponsorFilters();
            };
            
            const handleInputChange = (event) => {
                const { id, type } = event.target.dataset;
                const taskIndex = currentTasks.findIndex(t => t.id === id);
                if (taskIndex === -1) return;
                currentTasks[taskIndex][type] = event.target.value;
                if (type === 'start' || type === 'end') {
                    const task = currentTasks[taskIndex];
                    if (new Date(task.end) < new Date(task.start)) {
                        if (type === 'start') task.end = task.start;
                        else task.start = task.end;
                    }
                }
                refreshUI();
                localStorage.setItem('ganttCurrentTasks', JSON.stringify(currentTasks));
            };

            const updateVersionsDropdown = (versions) => {
                const selectedValue = elements.versionsSelect.value;
                elements.versionsSelect.innerHTML = '<option value="">-- Sélectionnez une version --</option>';
                versions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.id;
                    option.textContent = version.isDefault ? `${version.name} (par défaut)` : version.name;
                    elements.versionsSelect.appendChild(option);
                });
                if(selectedValue) elements.versionsSelect.value = selectedValue;
            };

            const populateModalDropdown = () => {
                elements.modalVersionsSelect.innerHTML = '<option value="new">Créer une nouvelle version</option>';
                allVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.id;
                    option.textContent = version.name;
                    elements.modalVersionsSelect.appendChild(option);
                });
            };

            const setCurrentTasks = (tasks) => {
                const tasksWithDefaults = tasks.map(task => {
                    let sponsor = task.sponsor, name = task.name;
                    if (!sponsor && name) {
                        const match = name.match(/^\[(.*?)\]\s*(.*)$/);
                        if (match && sponsors.includes(match[1])) { [sponsor, name] = [match[1], match[2]]; }
                    }
                    return { id: task.id || `task_${new Date().getTime()}_${Math.random()}`, ...task, sponsor: sponsor || sponsors[0], name, status: task.status || 'À faire', description: task.description || '' };
                });
                currentTasks = JSON.parse(JSON.stringify(tasksWithDefaults));
                localStorage.setItem('ganttCurrentTasks', JSON.stringify(currentTasks));
                refreshUI();
            };
            
            const loadVersionFromFirestore = async (versionId) => { if (!versionId) return; try { const doc = await db.collection("versions").doc(versionId).get(); if (doc.exists) setCurrentTasks(doc.data().tasks); } catch (error) { console.error("Erreur de lecture", error); } };
            
            const handleSaveOrUpdateVersion = async () => {
                const selectedActionId = elements.modalVersionsSelect.value;
                const newName = elements.versionNameInput.value.trim();
                const isDefault = elements.setAsDefaultCheckbox.checked;
                if (!newName) return alert("Le nom de la version ne peut pas être vide.");
                const plainTasks = JSON.parse(JSON.stringify(currentTasks));
                const versionData = { name: newName, tasks: plainTasks, isDefault };
                const existingNameQuery = await db.collection("versions").where("name", "==", newName).get();
                const nameExistsOnOtherDoc = !existingNameQuery.empty && existingNameQuery.docs[0].id !== selectedActionId;
                if (nameExistsOnOtherDoc) return alert(`Une autre version nommée "${newName}" existe déjà.`);
                try {
                    const batch = db.batch();
                    if (isDefault) {
                        const currentDefaultQuery = await db.collection("versions").where("isDefault", "==", true).get();
                        currentDefaultQuery.forEach(doc => {
                            if (doc.id !== selectedActionId) batch.update(doc.ref, { isDefault: false });
                        });
                    }
                    if (selectedActionId === 'new') {
                        const newDocRef = db.collection("versions").doc();
                        batch.set(newDocRef, versionData);
                    } else {
                        const docRef = db.collection("versions").doc(selectedActionId);
                        batch.update(docRef, versionData);
                    }
                    await batch.commit();
                    alert(`Version "${newName}" sauvegardée avec succès !`);
                    elements.saveModal.classList.add('hidden');
                } catch (error) { console.error("Erreur:", error); alert("Erreur lors de la sauvegarde."); }
            };

            const deleteVersionFromFirestore = async () => {
                const selectedId = elements.modalVersionsSelect.value;
                if (!selectedId || selectedId === 'new') return;
                const selectedOption = elements.modalVersionsSelect.options[elements.modalVersionsSelect.selectedIndex];
                const versionName = selectedOption.text;
                if (confirm(`Êtes-vous sûr de vouloir supprimer la version "${versionName}" ?`)) {
                    try {
                        await db.collection("versions").doc(selectedId).delete();
                        alert(`Version "${versionName}" supprimée.`);
                        setCurrentTasks(initialTasks);
                        elements.saveModal.classList.add('hidden');
                    } catch (error) { console.error("Erreur de suppression", error); }
                }
            };
            
            const listenForVersionsChanges = () => { 
                db.collection("versions").orderBy("name").onSnapshot(snapshot => { 
                    allVersions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateVersionsDropdown(allVersions);
                }, error => console.error("ERREUR FIRESTORE:", error)); 
            };
            
            const loadInitialTasks = async () => { 
                try { 
                    const snapshot = await db.collection("versions").where("isDefault", "==", true).limit(1).get(); 
                    if (!snapshot.empty) { 
                        const doc = snapshot.docs[0]; 
                        setCurrentTasks(doc.data().tasks); 
                        elements.versionsSelect.value = doc.id; 
                        return; 
                    } 
                } catch (e) { console.error(e); } 
                const saved = localStorage.getItem('ganttCurrentTasks'); 
                setCurrentTasks(saved ? JSON.parse(saved) : initialTasks); 
            };

            document.getElementById('confirm-desc-btn').addEventListener('click', () => {
                const id = elements.descModal.dataset.editingId;
                const taskIndex = currentTasks.findIndex(t => t.id === id);
                if (taskIndex > -1) {
                    currentTasks[taskIndex].description = elements.descModalTextarea.value;
                    localStorage.setItem('ganttCurrentTasks', JSON.stringify(currentTasks));
                    elements.descModal.classList.add('hidden');
                    updateCharts(displayedTasks);
                }
            });
            document.getElementById('cancel-desc-btn').addEventListener('click', () => elements.descModal.classList.add('hidden'));
            
            document.getElementById('manage-versions-btn').addEventListener('click', () => {
                populateModalDropdown();
                elements.modalVersionsSelect.value = 'new';
                elements.versionNameInput.value = '';
                elements.versionNameInput.placeholder = 'Nom de la nouvelle version...';
                elements.confirmDeleteBtn.classList.add('hidden');
                elements.defaultVersionWrapper.classList.add('hidden');
                elements.saveModal.classList.remove('hidden');
                elements.versionNameInput.focus();
            });

            elements.modalVersionsSelect.addEventListener('change', (event) => {
                const selectedId = event.target.value;
                if (selectedId === 'new') {
                    elements.versionNameInput.value = '';
                    elements.versionNameInput.placeholder = 'Nom de la nouvelle version...';
                    elements.confirmDeleteBtn.classList.add('hidden');
                    elements.defaultVersionWrapper.classList.add('hidden');
                } else {
                    const selectedVersion = allVersions.find(v => v.id === selectedId);
                    if (selectedVersion) {
                        elements.versionNameInput.value = selectedVersion.name;
                        elements.setAsDefaultCheckbox.checked = selectedVersion.isDefault || false;
                    }
                    elements.confirmDeleteBtn.classList.remove('hidden');
                    elements.defaultVersionWrapper.classList.remove('hidden');
                }
            });
            
            document.getElementById('confirm-save-btn').addEventListener('click', handleSaveOrUpdateVersion);
            document.getElementById('cancel-save-btn').addEventListener('click', () => elements.saveModal.classList.add('hidden'));
            elements.confirmDeleteBtn.addEventListener('click', deleteVersionFromFirestore);

            elements.versionsSelect.addEventListener('change', () => loadVersionFromFirestore(elements.versionsSelect.value));
            
            document.getElementById('add-task-btn').addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                const newProject = {
                    id: `task_${new Date().getTime()}`, sponsor: sponsorFilter !== 'all' ? sponsorFilter : sponsors[0], name: 'Nouveau Projet',
                    start: today, end: today, description: '', status: 'À faire'
                };
                currentTasks.push(newProject);
                refreshUI();
                localStorage.setItem('ganttCurrentTasks', JSON.stringify(currentTasks));
            });

            document.getElementById('kpi-card-total').addEventListener('click', () => {
                showKpiDetailsModal('Total des Projets', currentTasks);
            });
            document.getElementById('kpi-card-late').addEventListener('click', () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const lateProjects = currentTasks.filter(t => new Date(t.end) < today && t.status !== 'Terminé');
                showKpiDetailsModal('Projets en Retard', lateProjects);
            });
            document.getElementById('kpi-card-in-progress').addEventListener('click', () => {
                const inProgressProjects = currentTasks.filter(t => t.status === 'En cours');
                showKpiDetailsModal('Projets en Cours', inProgressProjects);
            });
            document.getElementById('close-kpi-modal-btn').addEventListener('click', () => {
                elements.kpiDetailsModal.classList.add('hidden');
            });

            listenForVersionsChanges();
            loadInitialTasks();
        });
    </script>
</body>
</html>

